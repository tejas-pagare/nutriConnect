<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Common Sign-in Page</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="/css/Sign_in.css">

</head>
<body>
    <!-- Back Button -->
    <div id="cross" class="btn btn-outline-success" onclick="window.history.back();">
        <i class="fa-solid fa-xmark"></i>
    </div>

    <!-- Login Section -->
    <section id="login">
        <div class="container min-vh-100 d-flex justify-content-center align-items-center p-0">
            <div class="card p-4 shadow-lg" style="height: auto; max-width: 400px; width: 100%">
                <h2 class="text-center mb-4" id="loginTitle"><b>LOGIN</b></h2>

                <!-- User Login Form -->
                <form id="userLoginForm" class="signin-form user needs-validation"   data-redirect="/user"  novalidate >
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email:</label>
                        <input id="userEmail" type="email" class="form-control" placeholder="Enter Email" required minlength="5" maxlength="50" />
                        <div class="invalid-feedback">Please enter a valid email (5-50 characters).</div>
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Password:</label>
                        <input id="userPassword" type="password" class="form-control" placeholder="Enter Password" required minlength="8" maxlength="20" />
                        <div class="invalid-feedback">Password must be 8-20 characters.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMeUser" />
                        <label class="form-check-label" for="rememberMeUser">Remember Me</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <p class="text-center mt-3" style="cursor: pointer;">
                        Don't have an account? 
                        <a onclick="redirectToSignup('user')" style="color: #6a994e; text-decoration: none;">Sign Up</a>
                    </p>
                    <p class="text-center mt-2">
                        <a href="forgot-password.html" style="color: #6a994e; text-decoration: none;">Forgot Password?</a>
                    </p>
                </form>

                <!-- Dietitian Login Form -->
                <form id="dietitianLoginForm" class="signin-form dietitian needs-validation" data-redirect="/dietitian"  novalidate>
                    <div class="mb-3">
                        <label for="dietitianEmail" class="form-label">Email:</label>
                        <input id="dietitianEmail" type="email" class="form-control" placeholder="Enter Email" required minlength="5" maxlength="50" />
                        <div class="invalid-feedback">Please enter a valid email (5-50 characters).</div>
                    </div>
                    <div class="mb-3">
                        <label for="dietitianPassword" class="form-label">Password:</label>
                        <input id="dietitianPassword" type="password" class="form-control" placeholder="Enter Password" required minlength="8" maxlength="20" />
                        <div class="invalid-feedback">Password must be 8-20 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label for="dietitianlicenseNumber" class="form-label">License Number:</label>
                        <input id="dietitianlicenseNumber" type="text" class="form-control" placeholder="Enter License Number" required minlength="5" maxlength="20" />
                        <div class="invalid-feedback">License number must be 5-20 characters.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMeDietitian" />
                        <label class="form-check-label" for="rememberMeDietitian">Remember Me</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <p class="text-center mt-3" style="cursor: pointer;">
                        Don't have an account? 
                        <a onclick="redirectToSignup('dietitian')" style="color: #6a994e; text-decoration: none;">Sign Up</a>
                    </p>
                    <p class="text-center mt-2">
                        <a href="forgot-password.html" style="color: #6a994e; text-decoration: none;">Forgot Password?</a>
                    </p>
                </form>

                <!-- Admin Login Form -->
                <form id="adminLoginForm" class="signin-form admin needs-validation" data-redirect="/admin"  novalidate>
                    <div class="mb-3">
                        <label for="adminEmail" class="form-label">Email:</label>
                        <input id="adminEmail" type="email" class="form-control" placeholder="Enter Email" required minlength="5" maxlength="50" />
                        <div class="invalid-feedback">Please enter a valid email (5-50 characters).</div>
                    </div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Password:</label>
                        <input id="adminPassword" type="password" class="form-control" placeholder="Enter Password" required minlength="8" maxlength="20" />
                        <div class="invalid-feedback">Password must be 8-20 characters.</div>
                    </div>
                    <div class="mb-3">
                        <!-- Admin Key is Personal Security key -->
                        <label for="adminKey" class="form-label">Admin Key:</label>
                        <input id="adminKey" type="password" class="form-control" placeholder="Enter Admin Key" required minlength="5" maxlength="20" />
                        <div class="invalid-feedback">Admin key must be 5-20 characters.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMeAdmin" />
                        <label class="form-check-label" for="rememberMeAdmin">Remember Me</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <p class="text-center mt-3" style="cursor: pointer;">
                        Don't have an account?   
                        <a onclick="redirectToSignup('admin')" style="color: #6a994e; text-decoration: none;">Sign Up</a>
                    </p>
                    <p class="text-center mt-2">
                        <a href="forgot-password.html" style="color: #6a994e; text-decoration: none;">Forgot Password?</a>
                    </p>
                </form>

                <!-- Organization Login Form -->
                <form id="orgLoginForm" class="signin-form organization needs-validation" data-redirect="/organization"  novalidate>
                    <div class="mb-3">
                        <label for="orgName" class="form-label">Organization Name:</label>
                        <input id="orgName" type="text" class="form-control" placeholder="Enter Organization Name" required minlength="3" maxlength="50" />
                        <div class="invalid-feedback">Organization name must be 3-50 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label for="orgEmail" class="form-label">Email:</label>
                        <input id="orgEmail" type="email" class="form-control" placeholder="Enter Email" required minlength="5" maxlength="50" />
                        <div class="invalid-feedback">Please enter a valid email (5-50 characters).</div>
                    </div>
                    <div class="mb-3">
                        <label for="organizationId" class="form-label">Organization ID:</label>
                        <input id="organizationId" type="text" class="form-control" placeholder="Enter Organization ID" required minlength="5" maxlength="20" />
                        <div class="invalid-feedback">Organization ID must be 5-20 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label for="orgPassword" class="form-label">Password:</label>
                        <input id="orgPassword" type="password" class="form-control" placeholder="Enter Password" required minlength="8" maxlength="20" />
                        <div class="invalid-feedback">Password must be 8-20 characters.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMeOrg" />
                        <label class="form-check-label" for="rememberMeOrg">Remember Me</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <p class="text-center mt-3" style="cursor: pointer;">
                        Don't have an account? 
                        <a onclick="redirectToSignup('organization')" style="color: #6a994e; text-decoration: none;">Sign Up</a>
                    </p>
                    <p class="text-center mt-2">
                        <a href="forgot-password.html" style="color: #6a994e; text-decoration: none;">Forgot Password?</a>
                    </p>
                </form>
            </div>
        </div>
    </section>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="/js/port.js"></script> -->
    
    <script>
        // Function to redirect to the sign-up page with the selected role
        function redirectToSignup(role) {
            window.location.href = `/Sign_up?role=${role}`;
          }

        // Function to get query parameters from the URL
        function getQueryParams() {
            const params = {};
            window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, (str, key, value) => {
                params[key] = value;
            });
            return params;
        }

        // Function to show the appropriate form based on the role
        function showFormBasedOnRole(role) {
            const forms = document.querySelectorAll('.signin-form');
            forms.forEach(form => form.style.display = 'none');

            const formToShow = document.querySelector(`.signin-form.${role}`);
            if (formToShow) {
                formToShow.style.display = 'block';
            }
        }

        // Get the role from the URL and show the appropriate form
        const params = getQueryParams();
        const role = params.role;
        showFormBasedOnRole(role);


        if (role) {
            showFormBasedOnRole(role); // Pass the role to the function
        } else {
            console.error('No role specified in the URL.'); // Handle case where no role is provided
        }
      
        document.addEventListener('DOMContentLoaded', () => {
        
            const forms = document.querySelectorAll('.signin-form');
        
            forms.forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
        
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }
        
                    let formData = {};
                    let endpoint = '';
        
                    if (form.id === 'adminLoginForm') {
                        formData = {
                            email: document.getElementById('adminEmail').value,
                            password: document.getElementById('adminPassword').value,
                            adminKey: document.getElementById('adminKey').value
                        };
                        endpoint = `/signin/admin`;
                    } 
                    else if (form.id === 'dietitianLoginForm') {
                        formData = {
                            email: document.getElementById('dietitianEmail').value,
                            password: document.getElementById('dietitianPassword').value,
                            licenseNumber: document.getElementById('dietitianlicenseNumber').value
                        };
                        endpoint = `/signin/dietitian`;
                    } 
                    else if (form.id === 'userLoginForm') {
                        formData = {
                            email: document.getElementById('userEmail').value,
                            password: document.getElementById('userPassword').value
                        };
                        endpoint = `/signin/user`;
                    } 
                    else if (form.id === 'orgLoginForm') {
                        formData = {
                            orgName: document.getElementById('orgName').value,
                            email: document.getElementById('orgEmail').value,
                            orgId: document.getElementById('organizationId').value,
                            password: document.getElementById('orgPassword').value
                        };
                        endpoint = `/signin/organization`;
                    }
        
                    console.log('Submitting login data:', formData);
        
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData),
                        });
        
                        const result = await response.json();
        
                        if (result.success) {
                            alert('Sign-in successful!');
                            if (form.dataset.redirect) {
                                window.location.href = form.dataset.redirect;
                            }
                        } else {
                            alert(result.message || 'Sign-in failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    }
                });
            });
        });
        
    </script>
</body>
</html>